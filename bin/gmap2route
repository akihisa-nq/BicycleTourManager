#!/usr/bin/ruby
# coding: utf-8

$: << File.join(File.dirname(__FILE__), "../lib")

require "bicycle_tour_manager"

GNUPLOT = ENV["GNUPLOT"]
CACHE_DIR = ENV["BICYCLE_TOUR_MANAGER_CACHE"] || File.dirname(__FILE__)

PLOT_ELEVATION_MIN = -100
PLOT_ELEVATION_MAX = 1100

def dump_route(plan, output_file)
	count = 1

	File.open(output_file, "w:utf-8") do |file|
		file << <<EOF
スタート
+0.01h

EOF

		plan.each do |pc|
			pc.path_list.each.with_index do |route, j|
				count += 1

				file << <<EOF
★#{j + 2}
+#{route.distance}km

EOF
				if (count % 8) == 0
					file << <<EOF
--

EOF
				end
			end

			count = 0

			file << <<EOF
休み
+0.25h

-- PC#{pc.index} --

EOF
		end
	end
end

INPUT_FILE = ARGV.shift
INPUT_DIR = File.dirname(INPUT_FILE)

gmap_uri_parser = BTM::GoogleMapUriParser.new("#{CACHE_DIR}/cache_geocode.db")

plan = []
File.open(INPUT_FILE, "r:utf-8") do |file|
	file.each_line do |line|
		line.strip!

		if line =~ /^"PC(\d+)":(.*)$/
			route = gmap_uri_parser.parse_uri($2)
			route.fetch_elevation(
				"#{CACHE_DIR}/cache_route.db",
				"#{CACHE_DIR}/cache_elevation.db"
				)
			route.index = $1
			plan << route
		end
	end
end
plan.sort_by! {|e| e.index}

plotter = BTM::AltitudePloter.new(GNUPLOT, INPUT_DIR)
plotter.elevation_max = PLOT_ELEVATION_MAX
plotter.elevation_min = PLOT_ELEVATION_MIN

plan.each do |route|
	plotter.plot(route, "#{INPUT_DIR}/PC#{route.index}.png")
end
 
BTM::GpxStream.write_routes("#{INPUT_DIR}/route.gpx", plan)
dump_route(plan, "#{INPUT_DIR}/route_template.txt")

